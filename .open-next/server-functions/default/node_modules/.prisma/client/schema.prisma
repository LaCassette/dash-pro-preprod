// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  PRO
  ADMIN
}

enum ProStatus {
  PENDING // En attente de validation admin
  ACTIVE // Validé par un admin
  REJECTED // Rejeté par un admin
}

enum SubscriptionStatus {
  TRIAL // Période d'essai (14 jours)
  ACTIVE // Abonnement actif
  CANCELLED // Annulé
  PAST_DUE // Paiement en retard
  UNPAID // Impayé
}

enum SubscriptionPlan {
  MONTHLY // Mensuel 49€/mois
  YEARLY // Annuel 499€/an
}

enum ProgramType {
  SPORT
  NUTRITION
}

enum ChatType {
  DIRECT
  GROUP
}

model User {
  id        String     @id @default(uuid())
  auth0Id   String     @unique
  email     String
  name      String?
  picture   String?
  role      UserRole   @default(USER)
  proStatus ProStatus? // Statut pour les PROs (PENDING/ACTIVE/REJECTED)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  // Relations
  organizationMemberships OrganizationMember[]
  createdOrganizations    Organization[]           @relation("OrganizationOwner")
  createdPrograms         Program[]                @relation("ProgramCreator")
  userPrograms            Program[]                @relation("ProgramUser")
  sentMessages            Message[]                @relation("MessageSender")
  chatMemberships         ChatMember[]
  readMessages            MessageRead[]
  agents                  Agent[]
  profileForAgents        Agent[]                  @relation("AgentProfile")
  agentSessions           AgentSession[]
  sentInvitations         OrganizationInvitation[] @relation("SentInvitations")
  receivedInvitations     OrganizationInvitation[] @relation("ReceivedInvitations")
  organizationRequests    OrganizationRequest[]    @relation("OrganizationRequests")
  sportProfile            UserSportProfile?
  nutritionProfile        UserNutritionProfile?
  medicalProfile          UserMedicalProfile?
  lifestyleProfile        UserLifestyleProfile?
  subscription            Subscription?

  @@index([auth0Id])
  @@index([email])
  @@index([role, proStatus])
}

model Organization {
  id          String   @id @default(uuid())
  name        String
  logo        String? // base64, 200x200
  accentColor String? // hex color
  ownerId     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  owner       User                     @relation("OrganizationOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     OrganizationMember[]
  programs    Program[]
  chats       Chat[]
  invitations OrganizationInvitation[]
  requests    OrganizationRequest[]

  @@index([ownerId])
}

model OrganizationMember {
  id             String   @id @default(uuid())
  userId         String
  organizationId String
  joinedAt       DateTime @default(now())

  // Relations
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  CANCELLED
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}

model OrganizationInvitation {
  id             String           @id @default(uuid())
  organizationId String
  email          String // Email de l'utilisateur invité
  userId         String? // ID si l'utilisateur existe déjà
  status         InvitationStatus @default(PENDING)
  invitedById    String // PRO qui a envoyé l'invitation
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation("SentInvitations", fields: [invitedById], references: [id], onDelete: Cascade)
  user         User?        @relation("ReceivedInvitations", fields: [userId], references: [id], onDelete: SetNull)

  @@unique([organizationId, email, status])
  @@index([organizationId])
  @@index([email])
  @@index([userId])
}

model OrganizationRequest {
  id             String        @id @default(uuid())
  organizationId String
  userId         String
  status         RequestStatus @default(PENDING)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation("OrganizationRequests", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId, status])
  @@index([organizationId])
  @@index([userId])
}

model Program {
  id             String      @id @default(uuid())
  name           String
  description    String?
  type           ProgramType
  content        String      @db.Text // JSON content
  createdById    String
  userId         String? // User for whom the program is created
  organizationId String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  createdBy    User          @relation("ProgramCreator", fields: [createdById], references: [id], onDelete: Cascade)
  user         User?         @relation("ProgramUser", fields: [userId], references: [id], onDelete: Cascade)
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([createdById])
  @@index([userId])
  @@index([organizationId])
}

model Chat {
  id             String   @id @default(uuid())
  name           String?
  type           ChatType @default(DIRECT)
  organizationId String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  members      ChatMember[]
  messages     Message[]

  @@index([organizationId])
}

model ChatMember {
  id         String    @id @default(uuid())
  chatId     String
  userId     String
  joinedAt   DateTime  @default(now())
  lastReadAt DateTime? // Dernière fois que l'utilisateur a lu les messages du chat

  // Relations
  chat Chat @relation(fields: [chatId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([chatId, userId])
  @@index([chatId])
  @@index([userId])
}

model Message {
  id        String   @id @default(uuid())
  content   String   @db.Text
  chatId    String
  senderId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chat   Chat          @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender User          @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  readBy MessageRead[]

  @@index([chatId])
  @@index([senderId])
  @@index([createdAt])
}

model MessageRead {
  id        String   @id @default(uuid())
  messageId String
  userId    String
  readAt    DateTime @default(now())

  // Relations
  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([messageId, userId])
  @@index([messageId])
  @@index([userId])
  @@index([readAt])
}

model Agent {
  id            String   @id @default(uuid())
  name          String
  image         String? // base64
  prompt        String   @db.Text
  context       String?  @db.Text
  createdById   String
  profileUserId String? // User profile for this agent
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  createdBy   User           @relation(fields: [createdById], references: [id], onDelete: Cascade)
  profileUser User?          @relation("AgentProfile", fields: [profileUserId], references: [id], onDelete: SetNull)
  sessions    AgentSession[]

  @@index([createdById])
}

model AgentSession {
  id        String   @id @default(uuid())
  agentId   String
  userId    String // User who used the agent
  title     String? // Titre généré par l'IA basé sur la première question
  messages  String   @db.Text // JSON array of messages
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  agent Agent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([agentId])
  @@index([userId])
  @@index([createdAt])
}

model UserSportProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  data      String   @db.Text // Données chiffrées JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserNutritionProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  data      String   @db.Text // Données chiffrées JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserMedicalProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  data      String   @db.Text // JSON chiffré
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model UserLifestyleProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  data      String   @db.Text // JSON (peut être chiffré ou non)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Subscription {
  id                   String             @id @default(uuid())
  userId               String             @unique
  stripeCustomerId     String?            @unique // ID client Stripe
  stripeSubscriptionId String?            @unique // ID abonnement Stripe
  plan                 SubscriptionPlan?
  status               SubscriptionStatus @default(TRIAL)
  trialEndsAt          DateTime? // Fin de la période d'essai
  currentPeriodEnd     DateTime? // Fin de la période actuelle
  cancelAtPeriodEnd    Boolean            @default(false)
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([status])
}
