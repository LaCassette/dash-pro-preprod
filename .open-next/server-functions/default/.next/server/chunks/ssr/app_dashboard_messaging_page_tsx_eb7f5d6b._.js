module.exports=[352651,a=>{"use strict";var b=a.i(187924),c=a.i(572131),d=a.i(50944),e=a.i(278165),f=a.i(415925),g=a.i(703130),h=a.i(340695),i=a.i(205522),j=a.i(563588),k=a.i(692759),l=a.i(499548),l=l,m=a.i(781560),n=a.i(879360),o=a.i(533441);let p=(0,a.i(170106).default)("check-check",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);var q=a.i(277687),r=a.i(807706),s=a.i(46470),t=a.i(256711),u=a.i(965733),v=a.i(676504),w=a.i(905094),x=a.i(621958),y=a.i(595129),z=a.i(835181),A=a.i(564485);function B(){let{user:a}=(0,e.useUser)(),B=(0,d.useRouter)(),C=(0,d.useSearchParams)(),{toast:D}=(0,q.useToast)(),[E,F]=(0,c.useState)([]),[G,H]=(0,c.useState)(null),[I,J]=(0,c.useState)([]),[K,L]=(0,c.useState)(""),[M,N]=(0,c.useState)(!0),[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)(!1),[S,T]=(0,c.useState)(!1),[U,V]=(0,c.useState)(!1),W=(0,c.useRef)(null),X=(0,c.useRef)(null),Y=(0,f.useTranslations)("messaging");(0,f.useTranslations)("common");let Z=C.get("chatId");function $(){X.current&&(X.current.scrollTop=X.current.scrollHeight)}async function _(){try{let a=await fetch("/api/chats");if(!a.ok){let b=await a.json().catch(()=>({error:"Unknown error"}));throw console.error("Failed to fetch chats:",b),Error(b.error||"Failed to fetch chats")}let b=await a.json();if(F(b),Z){let a=b.find(a=>a.id===Z);a&&H(a)}}catch(a){console.error("Error fetching chats:",a),D({title:"Erreur",description:"Impossible de charger les conversations",variant:"destructive"})}finally{N(!1)}}async function aa(a,b=!1){try{let c=await fetch(`/api/chats/${a}/messages`);if(!c.ok){if(403===c.status){b&&D({title:"Erreur",description:"Vous n'avez plus accès à cette conversation",variant:"destructive"}),H(null),B.push("/dashboard/messaging");return}throw Error("Failed to fetch messages")}let d=await c.json();J(d),ag(d)}catch(a){console.error("Error fetching messages:",a),b&&D({title:"Erreur",description:"Impossible de charger les messages",variant:"destructive"})}}async function ab(a){if(a.preventDefault(),K.trim()&&G&&!O){P(!0);try{let a=await fetch(`/api/chats/${G.id}/messages`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:K.trim()})});if(!a.ok){let b=await a.json();throw Error(b.error||"Failed to send message")}let b=await a.json();J(a=>[...a,b]),L(""),await _(),setTimeout(()=>$(),100)}catch(a){D({title:"Erreur",description:a instanceof Error?a.message:"Impossible d'envoyer le message",variant:"destructive"})}finally{P(!1)}}}function ac(b){if(b.name)return b.name;if("DIRECT"===b.type){let c=b.members.find(b=>b.user.id!==a?.id);return c?.user.name||c?.user.email||"Conversation"}return"Groupe"}function ad(b){if("DIRECT"===b.type){let c=b.members.find(b=>b.user.id!==a?.id);return c?.user.picture||null}return null}function ae(){return G&&"DIRECT"===G.type?G.members.find(b=>b.user.id!==a?.id)?.user:null}async function af(a){try{await fetch(`/api/chats/${a}/read`,{method:"POST"}),_()}catch(a){console.error("Error marking chat as read:",a)}}async function ag(b){a&&Promise.all(b.filter(b=>b.senderId!==a.id&&!b.isRead).map(a=>fetch(`/api/messages/${a.id}/read`,{method:"POST"}).catch(b=>{console.error(`Error marking message ${a.id} as read:`,b)}))).then(()=>{G&&aa(G.id,!1),_()})}async function ah(){if(G&&!U){V(!0);try{let a=await fetch(`/api/chats/${G.id}`,{method:"DELETE"});if(!a.ok){let b=await a.json();throw Error(b.error||"Failed to delete chat")}D({title:"Succès",description:"Conversation supprimée avec succès"}),H(null),B.push("/dashboard/messaging"),_()}catch(a){D({title:"Erreur",description:a instanceof Error?a.message:"Impossible de supprimer la conversation",variant:"destructive"})}finally{V(!1),T(!1)}}}return(0,c.useEffect)(()=>{a&&_()},[a]),(0,c.useEffect)(()=>{if(Z&&E.length>0){let a=E.find(a=>a.id===Z);a&&(H(a),aa(a.id,!0))}},[Z,E]),(0,c.useEffect)(()=>{if(G){aa(G.id,!0);let a=setInterval(()=>{G&&aa(G.id,!1)},1e4);return()=>clearInterval(a)}},[G]),(0,c.useEffect)(()=>{if(X.current){let{scrollTop:a,scrollHeight:b,clientHeight:c}=X.current;(b-a-c<100||0===I.length)&&setTimeout(()=>$(),100)}},[I]),M?(0,b.jsx)("div",{className:"container mx-auto p-6",children:(0,b.jsx)("div",{children:"Chargement..."})}):(0,b.jsxs)("div",{className:"container mx-auto p-6",children:[(0,b.jsxs)("div",{className:"mb-6",children:[(0,b.jsx)("h1",{className:"text-3xl font-bold",children:Y("title")}),(0,b.jsx)("p",{className:"text-muted-foreground",children:Y("subtitle")})]}),(0,b.jsxs)("div",{className:"grid gap-4 lg:grid-cols-3 h-[calc(100vh-200px)]",children:[(0,b.jsxs)(g.Card,{className:"lg:col-span-1 flex flex-col",children:[(0,b.jsx)(g.CardHeader,{children:(0,b.jsx)(g.CardTitle,{children:"Conversations"})}),(0,b.jsx)(g.CardContent,{className:"flex-1 overflow-hidden p-0",children:(0,b.jsx)(s.ScrollArea,{className:"h-full",children:(0,b.jsx)("div",{className:"p-4 space-y-2",children:0===E.length?(0,b.jsx)("p",{className:"text-sm text-muted-foreground text-center py-8",children:Y("noConversations")}):E.map(a=>(0,b.jsx)("div",{onClick:()=>{H(a),B.push(`/dashboard/messaging?chatId=${a.id}`),af(a.id)},className:`p-3 rounded-lg cursor-pointer transition-colors ${G?.id===a.id?"bg-primary text-primary-foreground":"hover:bg-muted"}`,children:(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsxs)(r.Avatar,{className:"h-10 w-10",children:[(0,b.jsx)(r.AvatarImage,{src:ad(a)||void 0}),(0,b.jsx)(r.AvatarFallback,{children:ac(a).charAt(0).toUpperCase()})]}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsx)("p",{className:`font-medium truncate ${a.hasUnread?"font-bold":""}`,children:ac(a)}),a.unreadCount&&a.unreadCount>0&&(0,b.jsx)("span",{className:"ml-2 bg-primary text-primary-foreground text-xs rounded-full h-5 w-5 flex items-center justify-center",children:a.unreadCount>99?"99+":a.unreadCount})]}),(0,b.jsx)("div",{className:`text-xs truncate ${G?.id===a.id?"text-primary-foreground/80":a.hasUnread?"font-semibold text-foreground":"text-muted-foreground"}`,children:function(a){if(0===a.messages.length)return"Aucun message";let b=a.messages[0];return b.content.substring(0,50)+(b.content.length>50?"...":"")}(a)})]})]})},a.id))})})})]}),(0,b.jsx)(g.Card,{className:"lg:col-span-2 flex flex-col",children:G?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(g.CardHeader,{className:"border-b",children:(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsxs)(r.Avatar,{children:[(0,b.jsx)(r.AvatarImage,{src:ad(G)||void 0}),(0,b.jsx)(r.AvatarFallback,{children:ac(G).charAt(0).toUpperCase()})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(g.CardTitle,{children:ac(G)}),"DIRECT"===G.type&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:G.members.find(b=>b.user.id!==a?.id)?.user.email||""})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2",children:["DIRECT"===G.type&&ae()&&a?.role==="PRO"&&(0,b.jsxs)(u.Dialog,{open:Q,onOpenChange:R,children:[(0,b.jsx)(u.DialogTrigger,{asChild:!0,children:(0,b.jsx)(h.Button,{variant:"ghost",size:"sm",children:(0,b.jsx)(l.default,{className:"h-4 w-4"})})}),(0,b.jsxs)(u.DialogContent,{className:"max-w-4xl w-[95vw] h-[95vh] max-h-[95vh] !flex !flex-col !grid-cols-none gap-0 p-0 overflow-hidden",children:[(0,b.jsx)("div",{className:"flex-shrink-0 p-6 border-b bg-background",children:(0,b.jsxs)(u.DialogHeader,{children:[(0,b.jsxs)(u.DialogTitle,{children:["Profil de ",ae()?.name||ae()?.email]}),(0,b.jsx)(u.DialogDescription,{children:"Informations sportives et nutritionnelles du client"})]})}),(0,b.jsx)("div",{className:"flex-1 overflow-hidden min-h-0",children:(0,b.jsxs)(x.Tabs,{defaultValue:"sport",className:"w-full h-full flex flex-col",children:[(0,b.jsxs)(x.TabsList,{className:"flex-shrink-0 mx-6 mt-4 mb-4",children:[(0,b.jsxs)(x.TabsTrigger,{value:"sport",children:[(0,b.jsx)(z.Dumbbell,{className:"mr-2 h-4 w-4"}),"Profil Sportif"]}),(0,b.jsxs)(x.TabsTrigger,{value:"nutrition",children:[(0,b.jsx)(A.Apple,{className:"mr-2 h-4 w-4"}),"Profil Nutritionnel"]})]}),(0,b.jsx)(x.TabsContent,{value:"sport",className:"flex-1 overflow-hidden mt-0 px-6 pb-6",children:(0,b.jsx)(s.ScrollArea,{className:"h-full w-full",children:(0,b.jsx)("div",{className:"pr-4",children:(0,b.jsx)(y.UserProfileForm,{open:!0,onOpenChange:()=>{},userId:ae().id,type:"SPORT",embedded:!0,onSuccess:()=>{}})})})}),(0,b.jsx)(x.TabsContent,{value:"nutrition",className:"flex-1 overflow-hidden mt-0 px-6 pb-6",children:(0,b.jsx)(s.ScrollArea,{className:"h-full w-full",children:(0,b.jsx)("div",{className:"pr-4",children:(0,b.jsx)(y.UserProfileForm,{open:!0,onOpenChange:()=>{},userId:ae().id,type:"NUTRITION",embedded:!0,onSuccess:()=>{}})})})})]})})]})]}),(0,b.jsxs)(v.DropdownMenu,{children:[(0,b.jsx)(v.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsx)(h.Button,{variant:"ghost",size:"sm",children:(0,b.jsx)(n.MoreVertical,{className:"h-4 w-4"})})}),(0,b.jsx)(v.DropdownMenuContent,{align:"end",children:(0,b.jsxs)(v.DropdownMenuItem,{className:"text-destructive",onClick:()=>T(!0),children:[(0,b.jsx)(m.Trash2,{className:"mr-2 h-4 w-4"}),"Supprimer la conversation"]})})]})]})]})}),(0,b.jsxs)(g.CardContent,{className:"flex-1 flex flex-col p-0 overflow-hidden",children:[(0,b.jsx)("div",{ref:X,className:"flex-1 overflow-y-auto p-4",children:(0,b.jsx)("div",{className:"space-y-4",children:0===I.length?(0,b.jsx)("div",{className:"text-center text-muted-foreground py-8",children:Y("noMessages")}):(0,b.jsxs)(b.Fragment,{children:[I.map(c=>{let d=c.senderId===a?.id;return(0,b.jsxs)("div",{className:`flex gap-3 ${d?"flex-row-reverse":""}`,children:[(0,b.jsxs)(r.Avatar,{className:"h-8 w-8",children:[(0,b.jsx)(r.AvatarImage,{src:c.sender.picture||void 0}),(0,b.jsx)(r.AvatarFallback,{children:c.sender.name?c.sender.name.charAt(0).toUpperCase():c.sender.email.charAt(0).toUpperCase()})]}),(0,b.jsxs)("div",{className:`flex flex-col max-w-[70%] ${d?"items-end":"items-start"}`,children:[(0,b.jsx)("div",{className:`rounded-lg px-4 py-2 ${d?"bg-primary text-primary-foreground":"bg-muted"}`,children:(0,b.jsx)("p",{className:"text-sm whitespace-pre-wrap break-words",children:c.content})}),(0,b.jsxs)("div",{className:"flex items-center gap-1 mt-1",children:[(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:(0,t.format)(new Date(c.createdAt),"HH:mm")}),d&&(0,b.jsx)("div",{className:"ml-1",children:c.isReadByAll?(0,b.jsx)(p,{className:"h-3 w-3 text-primary"}):c.isRead?(0,b.jsx)(p,{className:"h-3 w-3 text-muted-foreground"}):(0,b.jsx)(o.Check,{className:"h-3 w-3 text-muted-foreground"})})]})]})]},c.id)}),(0,b.jsx)("div",{ref:W})]})})}),(0,b.jsxs)("form",{onSubmit:ab,className:"border-t p-4 flex gap-2",children:[(0,b.jsx)(i.Input,{value:K,onChange:a=>L(a.target.value),placeholder:"Tapez votre message...",disabled:O,onKeyDown:a=>{"Enter"!==a.key||a.shiftKey||(a.preventDefault(),ab(a))}}),(0,b.jsx)(h.Button,{type:"submit",disabled:O||!K.trim(),children:(0,b.jsx)(k.Send,{className:"h-4 w-4"})})]})]})]}):(0,b.jsx)(g.CardContent,{className:"flex-1 flex items-center justify-center",children:(0,b.jsxs)("div",{className:"text-center text-muted-foreground",children:[(0,b.jsx)(j.MessageSquare,{className:"h-12 w-12 mx-auto mb-4 opacity-50"}),(0,b.jsx)("p",{children:Y("selectConversation")})]})})})]}),(0,b.jsx)(w.AlertDialog,{open:S,onOpenChange:T,children:(0,b.jsxs)(w.AlertDialogContent,{children:[(0,b.jsxs)(w.AlertDialogHeader,{children:[(0,b.jsx)(w.AlertDialogTitle,{children:Y("deleteConfirmTitle")}),(0,b.jsx)(w.AlertDialogDescription,{children:Y("deleteConfirmDescription")})]}),(0,b.jsxs)(w.AlertDialogFooter,{children:[(0,b.jsx)(w.AlertDialogCancel,{disabled:U,children:"Annuler"}),(0,b.jsx)(w.AlertDialogAction,{onClick:ah,disabled:U,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:U?"Suppression...":"Supprimer"})]})]})})]})}a.s(["default",()=>B],352651)}];

//# sourceMappingURL=app_dashboard_messaging_page_tsx_eb7f5d6b._.js.map